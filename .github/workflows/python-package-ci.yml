name: Python Package CI

on:
  workflow_call:
    inputs:
      python-versions:
        description: 'JSON array of Python versions to test'
        required: false
        type: string
        default: '["3.12"]'
      django-versions:
        description: 'JSON array of Django versions to test (optional, for Django packages)'
        required: false
        type: string
        default: ''
      working-directory:
        description: 'Working directory for the project'
        required: false
        type: string
        default: '.'
      skip-tests:
        description: 'Skip test execution'
        required: false
        type: boolean
        default: false
      skip-lint:
        description: 'Skip linting'
        required: false
        type: boolean
        default: false
      skip-security:
        description: 'Skip security checks'
        required: false
        type: boolean
        default: false
      skip-build:
        description: 'Skip package build validation'
        required: false
        type: boolean
        default: false
      coverage-threshold:
        description: 'Minimum coverage percentage required'
        required: false
        type: number
        default: 0

# Cancel in-progress runs for the same workflow and branch/PR
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  lint:
    name: Code Quality
    runs-on: ubuntu-latest
    if: ${{ !inputs.skip-lint }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ fromJson(inputs.python-versions)[0] }}
          cache: 'pip'

      - name: Install dependencies
        working-directory: ${{ inputs.working-directory }}
        run: |
          python -m pip install --upgrade pip
          pip install ruff mypy

      - name: Lint with Ruff
        working-directory: ${{ inputs.working-directory }}
        run: |
          ruff check .

      - name: Check formatting with Ruff
        working-directory: ${{ inputs.working-directory }}
        run: |
          ruff format --check .

      - name: Type check with mypy
        working-directory: ${{ inputs.working-directory }}
        continue-on-error: true
        run: |
          if pip list | grep -q django-stubs; then
            pip install django-stubs
          fi
          mypy . || echo "MyPy found issues, but continuing..."

  security:
    name: Security Checks
    runs-on: ubuntu-latest
    if: ${{ !inputs.skip-security }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ fromJson(inputs.python-versions)[0] }}
          cache: 'pip'

      - name: Install package with dependencies
        working-directory: ${{ inputs.working-directory }}
        run: |
          python -m pip install --upgrade pip
          pip install -e .[dev] 2>/dev/null || pip install -e .

      - name: Run pip-audit for known vulnerabilities
        working-directory: ${{ inputs.working-directory }}
        run: |
          pip install pip-audit
          pip-audit || true

      - name: Run safety check
        working-directory: ${{ inputs.working-directory }}
        continue-on-error: true
        run: |
          pip install safety
          safety check --json || true

      - name: Run bandit security linter
        working-directory: ${{ inputs.working-directory }}
        run: |
          pip install bandit[toml]
          bandit -r . -f json -c pyproject.toml || bandit -r . -f json || true

  test:
    name: Test (Python ${{ matrix.python-version }}${{ matrix.django-version && format(' / Django {0}', matrix.django-version) || '' }})
    runs-on: ubuntu-latest
    if: ${{ !inputs.skip-tests }}

    strategy:
      fail-fast: false
      matrix:
        python-version: ${{ fromJson(inputs.python-versions) }}
        django-version: ${{ inputs.django-versions && fromJson(inputs.django-versions) || fromJson('[""]') }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'

      - name: Install dependencies
        working-directory: ${{ inputs.working-directory }}
        run: |
          python -m pip install --upgrade pip

          # Install Django version if specified
          if [ -n "${{ matrix.django-version }}" ]; then
            pip install "Django~=${{ matrix.django-version }}"
          fi

          # Install package with dev dependencies
          pip install -e .[dev] 2>/dev/null || pip install -e .

      - name: Run tests with coverage
        working-directory: ${{ inputs.working-directory }}
        run: |
          if pip list | grep -q pytest; then
            if pip list | grep -q pytest-cov; then
              pytest --cov --cov-report=xml --cov-report=term-missing
            else
              pytest
            fi
          else
            python -m unittest discover
          fi

      - name: Check coverage threshold
        if: ${{ inputs.coverage-threshold > 0 }}
        working-directory: ${{ inputs.working-directory }}
        run: |
          if pip list | grep -q coverage; then
            coverage report --fail-under=${{ inputs.coverage-threshold }}
          fi

      - name: Upload coverage to Codecov
        if: matrix.python-version == fromJson(inputs.python-versions)[0] && (!matrix.django-version || matrix.django-version == '4.2')
        uses: codecov/codecov-action@v4
        with:
          file: ${{ inputs.working-directory }}/coverage.xml
          fail_ci_if_error: false
          token: ${{ secrets.CODECOV_TOKEN }}

  build:
    name: Build Package
    runs-on: ubuntu-latest
    if: ${{ !inputs.skip-build }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ fromJson(inputs.python-versions)[0] }}
          cache: 'pip'

      - name: Install build tools
        run: |
          python -m pip install --upgrade pip
          pip install build twine

      - name: Build package
        working-directory: ${{ inputs.working-directory }}
        run: |
          python -m build

      - name: Check package with twine
        working-directory: ${{ inputs.working-directory }}
        run: |
          twine check dist/*

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: python-package-distributions
          path: ${{ inputs.working-directory }}/dist/
          retention-days: 7
